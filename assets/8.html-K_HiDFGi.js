import{_ as p,r as t,o as c,c as i,a as n,d as s,b as a,w as l,e as r}from"./app-muG4J4_9.js";const u="/assets/react-6-ZXqDubCf.png",d="/assets/react-7-lAOUO5Vr.png",k={},v=n("h1",{id:"_8-实现-usestate",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_8-实现-usestate","aria-hidden":"true"},"#"),s(" 8. 实现 useState")],-1),m={class:"hint-container info"},b=n("p",{class:"hint-container-title"},"摘要",-1),g=n("ul",null,[n("li",null,"支持 FuctionComponent"),n("li",null,"实现共享数据层"),n("li",null,"实现 useState")],-1),h={href:"https://github.com/2xiao/my-react/tree/v1.8",target:"_blank",rel:"noopener noreferrer"},y=n("code",null,"git tag v1.8",-1),w=r(`<h2 id="_1-支持-fuctioncomponent" tabindex="-1"><a class="header-anchor" href="#_1-支持-fuctioncomponent" aria-hidden="true">#</a> 1. 支持 FuctionComponent</h2><p>上一节我们实现了简单版的 <code>react-dom</code> 包，支持了首屏渲染触发更新，而 React 还有很多触发更新的方式，如类组件的 <code>this.setState()</code>、函数组件的 <code>useState useEffect</code>，这一节我们来实现函数组件的 <code>useState</code>。</p><p><code>useState</code> 是 React 中的一个 Hook，React Hooks 是 React 16.8 引入的一项特性，目的是让你在函数组件中使用状态和其他 React 特性，以替代类组件中的状态和生命周期方法。在函数组件中使用 Hooks 有一些规则和限制：</p><ul><li><strong>只能在函数组件中调用 Hooks：</strong> Hooks 依赖于 React 的函数组件机制，所以只能在函数组件中使用，而不能在类组件中使用。如果你需要在类组件中使用类似的功能，可以考虑使用 React 的类组件生命周期方法和状态管理机制。</li><li><strong>只能在顶层调用 Hooks：</strong> 不可以在条件语句、循环语句或嵌套函数中调用 Hooks。这确保 React 能够按照相同的顺序调用 Hooks，以确保状态之间的关系保持一致。</li></ul><p>首先，我们需要将函数组件 <code>FunctionComponent</code> 加入到更新流程里面去，和 <code>HostComponet</code>、<code>HostText</code> 一样，<code>FunctionComponent</code> 的更新流程同样根植于 <code>beginWork</code> 和 <code>completeWork</code> 函数。</p><p>先在 <code>beginWork</code> 函数中增加 <code>FunctionComponent</code> 的情况判断，若 FiberNode 是函数组件，就调用 <code>updateFunctionComponent</code> 函数；</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// packages/react-reconciler/src/beginWork.ts</span>
<span class="token comment">// 比较并返回子 FiberNode</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">beginWork</span> <span class="token operator">=</span> <span class="token punctuation">(</span>workInProgress<span class="token operator">:</span> FiberNode<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> HostRoot<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> HostComponent<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> FunctionComponent<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> HostText<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token function">updateHostText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&#39;beginWork 未实现的类型&#39;</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>updateFunctionComponent</code>函数会调用函数组件本身来获取其返回的 React 元素树，例如函数组件 <code>function App() { return 123 }</code>，只需调用 <code>App()</code> 就可以得到其子节点，进而将子节点传给 <code>reconcileChildren</code> 协调处理子节点的更新逻辑；</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// packages/react-reconciler/src/beginWork.ts</span>
<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>workInProgress<span class="token operator">:</span> FiberNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> nextChildren <span class="token operator">=</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">reconcileChildren</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> nextChildren<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>调用函数组件的工作由 <code>renderWithHooks</code> 负责，函数保存在 FiberNode 的 <code>type</code> 字段中，因此只需要取出 <code>type</code> 字段执行以下即可得到其子节点；</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// packages/react-reconciler/src/fiberHooks.ts</span>
<span class="token comment">// 执行函数组件中的函数</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span>workInProgress<span class="token operator">:</span> FiberNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 函数保存在 type 字段中</span>
	<span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
	<span class="token keyword">const</span> props <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
	<span class="token comment">// 执行函数</span>
	<span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> children<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同样，在 <code>completeWork</code> 函数中增加 <code>FunctionComponent</code> 的情况判断，和 <code>HostRoot</code> 一样，不需要做其他的处理，直接向上冒泡即可；</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// packages/react-reconciler/src/completeWork.ts</span>
<span class="token comment">// 生成更新计划，计算和收集更新 flags</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">completeWork</span> <span class="token operator">=</span> <span class="token punctuation">(</span>workInProgress<span class="token operator">:</span> FiberNode<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
	<span class="token keyword">const</span> current <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> HostRoot<span class="token operator">:</span>
		<span class="token keyword">case</span> FunctionComponent<span class="token operator">:</span>
			<span class="token function">bubbleProperties</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样，我们就实现了 <code>FunctionComponent</code> 的基本功能。</p><h2 id="_2-实现共享数据层" tabindex="-1"><a class="header-anchor" href="#_2-实现共享数据层" aria-hidden="true">#</a> 2. 实现共享数据层</h2><p>我们知道 Hooks 只能在函数组件中调用，若我们在一个 Hook 的回调函数中调用另一个 Hook 会报错，类似下面这样：</p><div class="language-jsx line-numbers-mode" data-ext="jsx"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那 Hooks 如何感知被调用的上下文环境呢？</p><p>方法是在不同上下文中，调用的 Hooks 不是同一个函数。在 mount 时、update 时、以及其它上下文中，分别实现不同的 Hooks 函数，从而确保 Hooks 在正确的上下文环境中执行。</p><figure><img src="`+u+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>我们调用<code>useState</code> 时的一般语法是：</p><div class="language-jsx line-numbers-mode" data-ext="jsx"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看出，<code>useState</code> 是被 <code>react</code> 包导出，而要想感知上下文环境，则需要依赖 <code>react-reconciler</code> 包中的更新流程，也就是说两个包之间需要共享数据，因此就需要实现一个内部数据共享层（ReactSharedInternals）。</p><p>先在 <code>react</code> 包中新建一个 <code>currentDispatcher.ts</code> 文件，里面保存了当前使用的 Hooks 指针 <code>currentDispatcher</code>，同时导出一个 <code>resolveDispatcher</code> 函数，方便查询当前使用的 Hooks 集合:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// packages/react/src/currentDispatcher.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Action <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;shared/ReactTypes&#39;</span><span class="token punctuation">;</span>

<span class="token comment">// const [data, setData] = useState(0);</span>
<span class="token comment">// or</span>
<span class="token comment">// const [data, setData] = useState(0data) =&gt; data + 1);</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Dispatcher</span> <span class="token punctuation">{</span>
	useState<span class="token operator">:</span> <span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>initialState<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">Dispatch<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span>action<span class="token operator">:</span> Action<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> currentDispatcher<span class="token operator">:</span> <span class="token punctuation">{</span> current<span class="token operator">:</span> Dispatcher <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	current<span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> resolveDispatcher <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Dispatcher <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> dispatcher <span class="token operator">=</span> currentDispatcher<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>dispatcher <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;Hooks 只能在函数组件中执行&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> dispatcher<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> currentDispatcher<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着，在<code>react/index.ts</code> 中对外暴露 <code>useState</code> 函数，这个函数返回的是 <code>currentDispatcher.current.useState</code>；</p><p>同事将内部共享数据层暴露出去，里面包含了 <code>currentDispatcher</code> 的数据。React 官方为内部共享数据层取了一个很长的名字，以警告开发者不要随便修改里面的数据：</p><p><code>__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED</code>。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// packages/react/index.ts</span>
<span class="token keyword">import</span> currentDispatcher<span class="token punctuation">,</span> <span class="token punctuation">{</span>
	Dispatcher<span class="token punctuation">,</span>
	resolveDispatcher
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./src/currentDispatcher&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> jsx <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./src/jsx&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> useState<span class="token operator">:</span> Dispatcher<span class="token punctuation">[</span><span class="token string">&#39;useState&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>initialState<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> dispatcher <span class="token operator">=</span> <span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> dispatcher<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 内部数据共享层</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> __SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED <span class="token operator">=</span> <span class="token punctuation">{</span>
	currentDispatcher
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
	version<span class="token operator">:</span> <span class="token string">&#39;1.0.0&#39;</span><span class="token punctuation">,</span>
	createElement<span class="token operator">:</span> jsx
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了将 <code>react-reconciler</code> 包和 <code>react</code> 包解耦，我们不直接从<code>react</code> 包中调用数据共享层，而是通过 <code>shared</code> 包中转一下：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// packages/shared/internals.ts</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span>

<span class="token comment">// 为了将 react-reconciler 和 react 解耦，在 shared 中转，方便 react-reconciler 使用</span>
<span class="token keyword">const</span> internals <span class="token operator">=</span> React<span class="token punctuation">.</span>__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED<span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> internals<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在，我们就可以在 <code>react</code> 包通过数据共享层获取当前的上下文环境，并返回不同的 Hooks 集合了，接下来，我们需要在 <code>react-reconciler</code> 包中实现对应不同上下文环境的 Hooks 集合。</p><h2 id="_3-实现-usestate" tabindex="-1"><a class="header-anchor" href="#_3-实现-usestate" aria-hidden="true">#</a> 3. 实现 useState</h2><p>前面我们提到，在 <code>beginWork</code> 阶段，为了获取函数组件的 <code>children</code>，在 <code>updateFunctionComponent</code> 函数中会调用 <code>renderWithHooks</code> 方法。<code>renderWithHooks</code> 方法会调用函数组件，并在执行的过程中，执行相应的 hook 方法。</p><p>因此，我们需要在 <code>renderWithHooks</code> 方法中判断当前的上下文环境，来决定要调用哪个 Hooks 集合，判断的方法是根据 <code>workInProgress.alternate</code>：</p><ul><li>若它为 <code>null</code>，代表此时还没有真实 DOM 树（首屏还没有渲染），所以是 mount 阶段，应该调用 mount 阶段对应的 Hooks 集合： <code>HooksDispatcherOnMount</code>，将它赋值给 <code>currentDispatcher</code>；</li><li>否则就是 update 阶段，应该调用 update 阶段对应的 Hooks 集合： <code>HooksDispatcherOnUpdate</code></li></ul><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// packages/react-reconciler/src/fiberHooks.ts</span>
<span class="token comment">// ...</span>
<span class="token keyword">import</span> internals <span class="token keyword">from</span> <span class="token string">&#39;shared/internals&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> currentDispatcher <span class="token punctuation">}</span> <span class="token operator">=</span> internals<span class="token punctuation">;</span>

<span class="token comment">// 执行函数组件中的函数</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span>workInProgress<span class="token operator">:</span> FiberNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 赋值</span>
	currentlyRenderingFiber <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
	workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

	<span class="token comment">// 判断 Hooks 被调用的时机</span>
	<span class="token keyword">const</span> current <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 组件的更新阶段(update)</span>
		currentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span> HooksDispatcherOnUpdate<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// 首屏渲染阶段(mount)</span>
		currentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span> HooksDispatcherOnMount<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 函数保存在 type 字段中</span>
	<span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
	<span class="token keyword">const</span> props <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
	<span class="token comment">// 执行函数</span>
	<span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 重置</span>
	currentlyRenderingFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	workInProgressHook <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> children<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> HooksDispatcherOnMount<span class="token operator">:</span> Dispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
	useState<span class="token operator">:</span> mountState
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> HooksDispatcherOnUpdate<span class="token operator">:</span> Dispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
	useState<span class="token operator">:</span> updateState
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，<code>currentlyRenderingFiber</code> 是一个全局变量，用于跟踪当前正在被处理的 FiberNode 节点，以便在调用 Hooks 时能找到正确的 FiberNode 节点，将状态和上下文与之相关联。<code>workInProgressHook</code> 也是一个全局变量，用于跟踪当前正在进行工作的 Hook。</p><p>接着，我们来实现 mount 阶段对应的 <code>useState</code> 方法：<code>mountState</code>，先定义一下 Hook 的数据结构：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 定义 Hook 数据结构</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>
	memoizedState<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span> <span class="token comment">// 保存 Hook 的数据</span>
	queue<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
	next<span class="token operator">:</span> Hook <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意，Hook 和 FiberNode 都有 <code>memoizedState</code> 字段，但是二者的含义不一样，两者的关系如下图：</p><figure><img src="`+d+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>在 <code>Reconciler</code> 更新流程中，会遍历 Fiber 树，而 <code>workInProgress</code> 字段指向了当前正在被执行的 FiberNode 节点，该节点的 <code>memoizedState</code> 字段中保存着待执行的 Hooks 链表；链表中的每个 Hook 通过 <code>next</code> 指针连接在一起，每个 Hook 都有一个 <code>memoizedState</code> 字段，指向了对应的 Hook 数据。</p><p>接着实现 <code>mountState</code>，现在需要做两件事：</p><ul><li>从 Hooks 链表中获取当前正在工作的 <code>useState</code></li><li>获取当前 <code>useState</code> 对应的 Hook 数据</li></ul><p>实现 <code>mountWorkInProgressHook</code> 函数，负责从 Hooks 链表中获取当前正在工作的 Hook。对于 mount 阶段，我们需要新建一个 Hook，然后将它赋值给 <code>workInProgressHook</code> 变量，这个变量的含义就是当前正在工作的 Hook，同时还需要注意，Hooks 是一个链表，链表中的每个 Hook 通过 <code>next</code> 指针连接在一起，所以要维护好 <code>next</code> 指针。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 获取当前正在工作的 Hook</span>
<span class="token keyword">function</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Hook <span class="token punctuation">{</span>
	<span class="token keyword">const</span> hook<span class="token operator">:</span> Hook <span class="token operator">=</span> <span class="token punctuation">{</span>
		memoizedState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
		queue<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
		next<span class="token operator">:</span> <span class="token keyword">null</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressHook <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// mount 时的第一个hook</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>currentlyRenderingFiber <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			workInProgressHook <span class="token operator">=</span> hook<span class="token punctuation">;</span>
			currentlyRenderingFiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> workInProgressHook<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// currentlyRenderingFiber == null 代表 Hook 执行的上下文不是一个函数组件</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;Hooks 只能在函数组件中执行&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// mount 时的其他 hook</span>
		<span class="token comment">// 将当前工作的 Hook 的 next 指向新建的 hook，形成 Hooks 链表</span>
		workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook<span class="token punctuation">;</span>
		<span class="token comment">// 更新当前工作的 Hook</span>
		workInProgressHook <span class="token operator">=</span> hook<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> workInProgressHook<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于 mount 阶段来说，当前 <code>useState</code> 对应的 Hook 数据就是 <code>initialState</code>，我们需要将这个数据存放在 Hook 的 <code>memoizedState</code> 变量中。另外，因为 <code>useState</code> 可以触发更新，所以我们创建一个 <code>UpdateQueue</code>，存放在 Hook 的 <code>queue</code> 变量中。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">mountState</span><span class="token generic class-name"><span class="token operator">&lt;</span>State<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
	initialState<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> State<span class="token punctuation">)</span> <span class="token operator">|</span> State
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span>State<span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
	<span class="token comment">// 当前正在工作的 useState</span>
	<span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 当前 useState 对应的 Hook 数据</span>
	<span class="token keyword">let</span> memoizedState<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>initialState <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token builtin">Function</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		memoizedState <span class="token operator">=</span> <span class="token function">initialState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		memoizedState <span class="token operator">=</span> initialState<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> memoizedState<span class="token punctuation">;</span>

	<span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token generic-function"><span class="token function">createUpdateQueue</span><span class="token generic class-name"><span class="token operator">&lt;</span>State<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	hook<span class="token punctuation">.</span>queue <span class="token operator">=</span> queue<span class="token punctuation">;</span>

	<span class="token comment">// 实现 dispatch</span>
	<span class="token keyword">const</span> dispatch <span class="token operator">=</span> <span class="token function">dispatchSetState</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> currentlyRenderingFiber<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
	queue<span class="token punctuation">.</span>dispatch <span class="token operator">=</span> dispatch<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token punctuation">[</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后我们还要实现 <code>useState</code> 的 <code>dispatch</code> 方法，并接入当前的更新流程。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 用于触发状态更新的逻辑</span>
<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">dispatchSetState</span><span class="token generic class-name"><span class="token operator">&lt;</span>State<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
	fiber<span class="token operator">:</span> FiberNode<span class="token punctuation">,</span>
	updateQueue<span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span><span class="token punctuation">,</span>
	action<span class="token operator">:</span> Action<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>updateQueue<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 调度更新</span>
	<span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,51),f=n("code",null,"useState",-1),H=n("code",null,"useState",-1),_=n("code",null,"dispatch",-1),S=n("code",null,"git tag v1.8",-1),x={href:"https://github.com/2xiao/my-react/tree/v1.8",target:"_blank",rel:"noopener noreferrer"};function I(D,P){const e=t("ExternalLinkIcon"),o=t("RouterLink");return c(),i("div",null,[v,n("div",m,[b,g,n("p",null,[s("相关代码可在 "),n("a",h,[y,a(e)]),s(" 查看")])]),w,n("p",null,[s("至此，我们就实现了函数组件中的 "),f,s(" 方法，但是 "),H,s(" 的 "),_,s(" 还没有完全实现，因为我们还没有实现 update 流程，如：删除节点、更新节点等，这些功能将在 "),a(o,{to:"/my-react/10.html"},{default:l(()=>[s("第 10 节")]),_:1}),s(" 中实现。")]),n("p",null,[s("相关代码可在 "),S,s(" 查看，地址："),n("a",x,[s("https://github.com/2xiao/my-react/tree/v1.8"),a(e)])])])}const R=p(k,[["render",I],["__file","8.html.vue"]]);export{R as default};
